(()=>{"use strict";var e,t={96:(e,t,i)=>{var s=i(440);class l extends Phaser.Scene{constructor(){super({key:"BootScene"})}preload(){this.cameras.main.setBackgroundColor(10016391),this.createLoadingbar(),this.load.on("progress",(e=>{this.progressBar.clear(),this.progressBar.fillStyle(16774867,1),this.progressBar.fillRect(this.cameras.main.width/4,this.cameras.main.height/2-16,this.cameras.main.width/2*e,16)}),this),this.load.on("complete",(()=>{this.progressBar.destroy(),this.loadingBar.destroy()}),this),this.load.pack("preload","./assets/pack.json","preload"),this.load.on("complete",(()=>{this.progressBar.destroy(),this.loadingBar.destroy(),this.scene.start("GameScene")}),this)}create(){this.createAnimations()}createLoadingbar(){this.loadingBar=this.add.graphics(),this.loadingBar.fillStyle(6139463,1),this.loadingBar.fillRect(this.cameras.main.width/4-2,this.cameras.main.height/2-18,this.cameras.main.width/2+4,20),this.progressBar=this.add.graphics()}createAnimations(){this.anims.create({key:"indicator-animation",frames:[{key:"indicator-0"},{key:"indicator-1"},{key:"indicator-2"},{key:"indicator-3"}],frameRate:10,repeat:-1});let e=[];for(let t=5;t<=17;t++)e.push({key:`boom-${t.toString().padStart(2,"0")}`});this.anims.create({key:"bomb-animation",frames:e,frameRate:15})}}const r=l,h=["red","yellow","green","purple","blue"],o={score:0,highscore:0,gridWidth:8,gridHeight:8,tileWidth:72,tileHeight:72,candyColors:["red","yellow","green","purple","blue","orange"],normalCandyTextureKey:{red:"item-01",yellow:"item-02",green:"item-03",purple:"item-04",blue:"item-05",orange:"item-06"},verticalStripesCandyTextureKey:{red:"item-01-stripes-vert",yellow:"item-02-stripes-vert",green:"item-03-stripes-vert",purple:"item-04-stripes-vert",blue:"item-05-stripes-vert",orange:"item-06-stripes-vert"},horizontalStripesCandyTextureKey:{red:"item-01-stripes-horiz",yellow:"item-02-stripes-horiz",green:"item-03-stripes-horiz",purple:"item-04-stripes-horiz",blue:"item-05-stripes-horiz",orange:"item-06-stripes-horiz"},bombCandyTextureKey:{red:"bomb-items-01",yellow:"bomb-items-02",green:"bomb-items-03",purple:"bomb-items-04",blue:"bomb-items-05",orange:"bomb-items-06"},bearCandyTextureKey:{red:"item-mar-01",yellow:"item-mar-02",green:"item-mar-03",purple:"item-mar-04",blue:"item-mar-05",orange:"item-mar-06"},cholateCandyTextureKey:"game-item-h",itemSpot1TextureKey:"item-spot",itemSpot2TextureKey:"item-spot-2"},n=class{static applyImageScaleTweens(e,t,i,s=e.scaleX,l=e.scaleY,r=.95,h=100){let o,n=!1,a=null,d=null;const c=()=>{d&&d.complete(),o=new Phaser.Math.Vector2(s,l);const t=o.x*r,i=o.y*r;n=!0,a=e.scene.tweens.add({targets:e,scaleX:t,scaleY:i,duration:h,ease:"Linear",onComplete:()=>{e.setScale(t,i),a=null}})},p=()=>{n&&(a&&a.stop(),n=!1,d=e.scene.tweens.add({targets:e,scaleX:o.x,scaleY:o.y,duration:h,ease:"Linear",onComplete:()=>{e.setScale(o.x,o.y),d=null}}))};"string"==typeof t&&(t=[t]),t.forEach((t=>{e.on(t,c)})),"string"==typeof i&&(i=[i]),i.forEach((t=>{e.on(t,p)}))}static applyImageDisplaySizeTweens(e,t,i,s=e.displayWidth,l=e.displayHeight,r=.95,h=100){let o,n=!1,a=null,d=null;const c=()=>{d&&d.complete(),o=new Phaser.Math.Vector2(s,l);const t=o.x*r,i=o.y*r;n=!0,a=e.scene.tweens.add({targets:e,displayWidth:t,displayHeight:i,duration:h,ease:"Linear",onComplete:()=>{e.setDisplaySize(t,i),a=null}})},p=()=>{n&&(a&&a.stop(),n=!1,d=e.scene.tweens.add({targets:e,displayWidth:o.x,displayHeight:o.y,duration:h,ease:"Linear",onComplete:()=>{e.setDisplaySize(o.x,o.y),d=null}}))};"string"==typeof t&&(t=[t]),t.forEach((t=>{e.on(t,c)})),"string"==typeof i&&(i=[i]),i.forEach((t=>{e.on(t,p)}))}};class a extends Phaser.GameObjects.Image{constructor(e){super(e.scene,e.x,e.y,e.texture,e.frame),this.tileWidth=0,this.tileHeight=0,this.mapTween=new Map,this.isPointerOver=!1,this.isDestroyed=!1,this.isPop=!1,this.setOrigin(.5,.5),this.scene.add.existing(this)}disableTileInteraction(){this.isDestroyed||(this.disableInteractive(),this.isPointerOver&&this.emit("pointerout"),this.off("pointerover"),this.off("pointerout"))}enableTileInteraction(){this.isDestroyed||(this.setInteractive(),this.on("pointerover",this.onPointerOver,this),this.on("pointerout",this.onPointerOut,this),n.applyImageDisplaySizeTweens(this,"pointerover","pointerout",this.tileWidth,this.tileHeight,1.1,100))}addMapTween(e,t){this.mapTween.set(e,t)}getMapTween(e){return this.mapTween.get(e)}removeMapTween(e){this.mapTween.delete(e)}onPointerOver(){this.isPointerOver=!0}onPointerOut(){this.isPointerOver=!1}setTileEffect(e){return this.tileEffect=e,this}setAppear(e=[]){return this.tileEffect.onTileAppear(e),this}setTileGrid(e,t,i){return this.grid=e,this.tileWidth=t,this.tileHeight=i,this.enableTileInteraction(),this}getWorldPosition(){const e=this.grid.getWorldTransformMatrix();let t=this.getLocalTransformMatrix();return t.tx+=e.tx,t.ty+=e.ty,t}getTileGrid(){return this.grid}getTileWidth(){return this.tileWidth}getTileHeight(){return this.tileHeight}getColor(){return this.tileEffect.color}getTileEffect(){return this.tileEffect}pop(){this.isPop||(this.isPop=!0,this.tileEffect.onTilePop())}swapPop(e){this.tileEffect.onTileSwapPop(e.getTileEffect())}destroy(e,t,i=!0){this.isDestroyed||(this.isDestroyed=!0,i&&this.tileEffect.onTileDestroy(t),super.destroy(e))}}const d=a;class c extends Phaser.Events.EventEmitter{constructor(e,t){super(),this.timeoutDuration=3e3,this.scene=e,this.tileSwapper=t,this.selectingTile=null,this.indicator=this.scene.add.sprite(0,0,"indicator-0"),this.indicator.setVisible(!1),this.indicator.setScale(2.3),this.indicator.play("indicator-animation"),this.createTimer(),this.registerInputEvents(e),this.on(c.CLICKED_INPUT_EVENT,(()=>{this.resetTimer()}))}createTimer(){this.timer=this.scene.time.addEvent({delay:this.timeoutDuration,loop:!0,callback:()=>{this.emit(c.NO_INPUT_PERIOD_EVENT)}})}registerInputEvents(e){e.input.on("gameobjectdown",((e,t,i)=>{if(this.emit(c.CLICKED_INPUT_EVENT),!0===this.tileSwapper.getCanMove()){if(this.tileSwapper.selectTile(t),this.tileSwapper.checkIsSwapped())this.selectingTile=null,this.indicator.setVisible(!1);else{this.selectingTile=t,this.indicator.setVisible(!0);let i=this.selectingTile.getWorldTransformMatrix();this.indicator.setPosition(i.tx,i.ty),this.downPosition=new Phaser.Math.Vector2(e.x,e.y)}this.tileSwapper.checkFirstTileSelected()||(this.selectingTile=null,this.indicator.setVisible(!1))}})),e.input.on("gameobjectup",((e,t,i)=>{this.emit(c.CLICKED_INPUT_EVENT),this.tileSwapper.getCanMove()&&this.selectingTile&&this.selectingTile!==t&&(this.tileSwapper.selectTile(t),this.selectingTile=null,this.indicator.setVisible(!1))})),e.input.on("pointerover",((e,t)=>{t.forEach((e=>{e instanceof d&&this.tileSwapper.getCanMove()&&this.selectingTile&&this.selectingTile!==e&&(this.tileSwapper.selectTile(e),this.selectingTile=null,this.indicator.setVisible(!1))}))}))}resetTimer(){this.timer.reset({delay:this.timeoutDuration,loop:!0,callback:()=>{this.emit(c.NO_INPUT_PERIOD_EVENT)}})}stopTimer(){this.timer.paused=!0,this.timer.reset({delay:this.timeoutDuration,loop:!0,callback:()=>{this.emit(c.NO_INPUT_PERIOD_EVENT)}})}startTimer(){this.timer.paused=!1}}c.NO_INPUT_PERIOD_EVENT="no input period",c.CLICKED_INPUT_EVENT="clicked input";const p=c;class u extends s.GameObjects.Container{constructor(e,t,i,s,l,r,h,o,n=[]){super(e,t,i),this.scene=e,this.gridWidth=s,this.gridHeight=l,this.tileWidth=r,this.tileHeight=h,this.tileFactory=o,this.gridTextures=n,this.scene.add.existing(this),this.initializeGrid()}initializeGrid(){if(0!=this.gridTextures.length)if(1===this.gridTextures.length)for(let e=0;e<this.gridHeight;e++)for(let t=0;t<this.gridWidth;t++){let i=this.scene.add.image(t*this.tileWidth,e*this.tileHeight,this.gridTextures[0]);i.setDisplaySize(this.tileWidth,this.tileHeight),i.setOrigin(0,0),this.add(i),this.sendToBack(i)}else if(2===this.gridTextures.length)for(let e=0;e<this.gridHeight;e++)for(let t=0;t<this.gridWidth;t++){let i=this.scene.add.image(t*this.tileWidth,e*this.tileHeight,this.gridTextures[(t+e)%2]);i.setDisplaySize(this.tileWidth,this.tileHeight),i.setOrigin(0,0),this.add(i),this.sendToBack(i)}}initializeTiles(){this.tileGrid=[];for(let e=0;e<this.gridHeight;e++){this.tileGrid[e]=[];for(let t=0;t<this.gridWidth;t++){let i=this.createRandomTile(t,e-this.gridHeight);this.tileGrid[e][t]=i,this.emit(u.TILE_ADD_EVENT,i,t,e-this.gridHeight,t,e)}}this.popedTilesGrid=[];for(let e=0;e<this.gridHeight;e++){this.popedTilesGrid[e]=[];for(let t=0;t<this.gridWidth;t++)this.popedTilesGrid[e][t]=null}this.emit(u.TILE_CHANGE_EVENT)}getTileIndex(e,t=!1){let i=null;for(let t=0;t<this.tileGrid.length;t++)for(let s=0;s<this.tileGrid[t].length;s++)if(e===this.tileGrid[t][s])return i=new Phaser.Math.Vector2(s,t),i;if(t)for(let t=0;t<this.popedTilesGrid.length;t++)for(let s=0;s<this.popedTilesGrid[t].length;s++)if(e===this.popedTilesGrid[t][s])return i=new Phaser.Math.Vector2(s,t),i;return i}getTileIndexInPopedGrid(e){let t=null;for(let i=0;i<this.popedTilesGrid.length;i++)for(let s=0;s<this.popedTilesGrid[i].length;s++)if(e===this.popedTilesGrid[i][s])return t=new Phaser.Math.Vector2(s,i),t;return t}gravitateTile(){for(let e=this.tileGrid.length-1;e>=0;e--)for(let t=this.tileGrid[e].length-1;t>=0;t--){if(null!==this.tileGrid[e][t])continue;let i=null,s=e-1;for(let l=e-1;l>=0&&null===i;l--)i=this.tileGrid[l][t],s=l;null!==i&&(this.tileGrid[e][t]=i,this.tileGrid[s][t]=null,this.emit(u.TILE_GRAVITATE_EVENT,i,t,s,t,e))}}fillEmptyGridWithTile(){for(var e=0;e<this.tileGrid.length;e++)for(var t=0;t<this.tileGrid[e].length;t++){if(null!==this.tileGrid[e][t])continue;let i=this.tileGrid.length;for(let s=e+1;s<this.tileGrid.length;s++)if(null!==this.tileGrid[s][t]){i=s;break}let s=this.createRandomTile(t,e-i);this.tileGrid[e][t]=s,this.emit(u.TILE_ADD_EVENT,s,t,e-i,t,e)}this.emit(u.TILE_CHANGE_EVENT)}destroyAllPopTiles(){for(let e=0;e<this.popedTilesGrid.length;e++)for(let t=0;t<this.popedTilesGrid[e].length;t++){const i=this.popedTilesGrid[e][t];null!==i&&(this.remove(i),i.destroy(),this.popedTilesGrid[e][t]=null)}}destroyPopTile(e,t,i=!0){let s=this.getTileIndexInPopedGrid(e);null!==s&&(this.remove(e),this.popedTilesGrid[s.y][s.x]=null,e.destroy(!0,t,i))}popTiles(e){for(var t=0;t<e.length;t++)this.popTile(e[t])}popTile(e){let t=this.getTileIndex(e);t&&(this.popedTilesGrid[t.y][t.x]=e,this.tileGrid[t.y][t.x]=null,e.pop())}swapPopTiles(e,t){let i=this.getTileIndex(e),s=this.getTileIndex(t);i&&s&&(this.popedTilesGrid[i.y][i.x]=t,this.popedTilesGrid[s.y][s.x]=e,this.tileGrid[i.y][i.x]=null,this.tileGrid[s.y][s.x]=null,e.swapPop(t))}addTileAtIndex(e,t,i){void 0===i&&(i=Math.floor(t/this.gridWidth),t%=this.gridWidth),e.setTileGrid(this,this.tileWidth,this.tileHeight),e.setDisplaySize(this.tileWidth,this.tileHeight),e.setPosition((t+.5)*this.tileWidth,(i+.5)*this.tileHeight),this.add(e),this.tileGrid[i][t]=e}addTileAtWorldPosition(e,t,i){let s=Math.floor((t-this.x)/this.tileWidth),l=Math.floor((i-this.y)/this.tileHeight);l>=0&&l<this.tileGrid.length&&s>=0&&s<this.tileGrid[l].length&&this.addTileAtIndex(e,s,l)}addTileAtLocalPosition(e,t,i){let s=Math.floor((t+.5)/this.tileWidth),l=Math.floor((i+.5)/this.tileHeight);l>=0&&l<this.tileGrid.length&&s>=0&&s<this.tileGrid[l].length&&this.addTileAtIndex(e,s,l)}removeTileAtIndex(e,t){void 0===t&&(t=Math.floor(e/this.gridWidth),e%=this.gridWidth);let i=this.tileGrid[t][e];return null===i||(this.remove(i),this.tileGrid[t][e]=null),i}removeTile(e){let t=this.getTileIndex(e);null!==t&&(this.remove(e),this.tileGrid[t.y][t.x]=null)}swapTiles(e,t){if(!e||!t)return;let i=e.x,s=e.y,l=t.x,r=t.y;this.tileGrid[s/this.tileHeight-.5][i/this.tileWidth-.5]=t,this.tileGrid[r/this.tileHeight-.5][l/this.tileWidth-.5]=e,this.emit(u.TILE_SWAP_EVENT,e,t),this.emit(u.TILE_CHANGE_EVENT)}getRandomTileInPopedGrid(){let e=[];for(let t=0;t<this.popedTilesGrid.length;t++)for(let i=0;i<this.popedTilesGrid[t].length;i++)null!==this.popedTilesGrid[t][i]&&e.push(this.popedTilesGrid[t][i]);return 0===e.length?null:e[Math.floor(Math.random()*e.length)]}getTileGrid(){return this.tileGrid}getFlattenTileGrid(){let e=[];for(let t=0;t<this.tileGrid.length;t++)for(let i=0;i<this.tileGrid[t].length;i++)null!==this.tileGrid[t][i]&&e.push(this.tileGrid[t][i]);return e}getPopedTileGrid(){return this.popedTilesGrid}getDistance(e,t){return Math.abs(e.x-t.x)+Math.abs(e.y-t.y)}getMahattanDistance(e,t){return new Phaser.Math.Vector2(Math.abs(e.x-t.x),Math.abs(e.y-t.y))}getMahattanIndexDistance(e,t){return new Phaser.Math.Vector2(Math.abs(e.x-t.x)/this.tileWidth,Math.abs(e.y-t.y)/this.tileHeight)}getRow(e){return this.tileGrid[e]}getColumn(e){let t=[];for(let i=0;i<this.tileGrid.length;i++)t.push(this.tileGrid[i][e]);return t}getTileAtIndex(e,t){return t<0||t>=this.tileGrid.length||e<0||e>=this.tileGrid[t].length?null:this.tileGrid[t][e]}getTileAtWorldPosition(e,t){let i=null,s=Math.floor((e-this.x)/this.tileWidth),l=Math.floor((t-this.y)/this.tileHeight);return l>=0&&l<this.tileGrid.length&&s>=0&&s<this.tileGrid[l].length&&(i=this.tileGrid[l][s]),i}getWorldPositionFromIndex(e,t){return void 0===t&&(t=Math.floor(e/this.gridWidth),e%=this.gridWidth),new Phaser.Math.Vector2((e+.5)*this.tileWidth+this.x,(t+.5)*this.tileHeight+this.y)}getWorldPositionFromTile(e){return new Phaser.Math.Vector2(e.x+this.x,e.y+this.y)}getLocalPositionFromIndex(e,t){return new Phaser.Math.Vector2((e+.5)*this.tileWidth,(t+.5)*this.tileHeight)}getRowCount(){return this.gridHeight}getColumnCount(){return this.gridWidth}createRandomTile(e,t){let i=this.tileFactory.createRandomTile((e+.5)*this.tileWidth,(t+.5)*this.tileHeight);return i.setTileGrid(this,this.tileWidth,this.tileHeight),this.add(i),i.setAppear(),i}}u.TILE_CHANGE_EVENT="tileChange",u.TILE_SWAP_EVENT="tileSwap",u.TILE_ADD_EVENT="tileAdd",u.TILE_GRAVITATE_EVENT="tileGravitate";const g=u,T=class{constructor(e,t){this.tiles=t,this.scene=e}start(){}stop(){}getCompleted(){return!1}update(){}getFlattenTiles(){return this.tiles.reduce(((e,t)=>{let i=t.filter((e=>null!==e));return e.concat(i)}),[])}},m=class extends T{constructor(){super(...arguments),this.tweens=[]}start(){super.start();for(let e=0;e<=2*(this.tiles.length-1);++e){let t=Math.max(0,e-this.tiles.length+1),i=Math.min(this.tiles.length-1,e);for(let s=t;s<=i;++s){let t=e-s;if(null===this.tiles[s][t])continue;let i=this.createWaveTween(this.tiles[s][t],e);this.tweens.push(i)}}}createWaveTween(e,t){return this.scene.tweens.add({targets:e,delay:100*t,displayWidth:1.2*e.getTileWidth(),displayHeight:1.2*e.getTileHeight(),yoyo:!0,ease:"Quad.InOut",duration:150,onComplete:()=>{e.setDisplaySize(e.getTileWidth(),e.getTileHeight())}})}};class y extends s.GameObjects.Graphics{constructor(e,t,i,s){super(e),this.scene=e,this.x=t,this.y=i,this.index=s}}const f=y,x=class extends T{constructor(e,t,i,s,l,r,h=(()=>{})){super(e,t.getTileGrid()),this.tileGrid=t,this.x=i,this.y=s,this.radius=l,this.duration=r,this.callback=h}start(){super.start();let e=[],t=[],i=this.getFlattenTiles();i.forEach((i=>{i.disableTileInteraction();let s=this.tileGrid.getWorldPositionFromTile(i),l=this.tileGrid.getTileIndex(i);null!==l?(this.tileGrid.removeTile(i),i.setPosition(s.x,s.y),e.push(new f(this.scene,s.x,s.y,l)),t.push(new f(this.scene,this.x,this.y,l))):console.error("TileCircleShuffleSimulation: Tile is not in the grid")})),Phaser.Utils.Array.Shuffle(i),Phaser.Utils.Array.Shuffle(t);const s=this.scene.add.group(e),l=(this.scene.add.group(t),this.scene.add.group(i)),r=new Phaser.Geom.Circle(this.x,this.y,this.radius);Phaser.Actions.PlaceOnCircle(s.getChildren(),r);let h=0;i.forEach(((s,o)=>{const n=e[o].getWorldTransformMatrix(),a=t[o],d=this.tileGrid.getWorldPositionFromIndex(a.index.x,a.index.y);this.scene.tweens.chain({tweens:[{targets:s,x:n.tx,y:n.ty,ease:Phaser.Math.Easing.Cubic.InOut,duration:this.duration/4},{targets:r,radius:this.radius,ease:"Linear",duration:this.duration/2,onUpdate:()=>{Phaser.Actions.RotateAroundDistance(l.getChildren(),{x:this.x,y:this.y},6e-4,r.radius)}},{targets:s,x:d.x,y:d.y,ease:Phaser.Math.Easing.Cubic.InOut,duration:this.duration/4}],onComplete:()=>{this.tileGrid.addTileAtIndex(s,a.index.x,a.index.y),s.enableTileInteraction(),++h===i.length&&this.callback()}})}))}};class S extends s.GameObjects.GameObject{constructor(e,t){super(e,"tileGridDirector"),this.scene=e,this.tileGrid=t}startIdle(){let e;Math.random(),e=new m(this.scene,this.tileGrid.getTileGrid()),e.start()}startShuffle(e,t,i,s=(()=>{})){let l;Math.random(),l=new x(this.scene,this.tileGrid,e,t,200,i,s),l.start()}endIdle(){}}const C=S,w=class{constructor(e,t){this.hintTweens=[],this.hintTiles=[],this.Scene=e,this.TileMatcher=t}startHintTiles(){let e=this.TileMatcher.getPotentialMatches();if(0===e.length)return;let t=e[Math.floor(Math.random()*e.length)],i=t.fromTile,s=t.toTile;this.hintTiles=[i,s,...t.matchTiles],this.hintTiles.forEach((e=>{let t=this.Scene.tweens.add({targets:e,displayWidth:1.2*e.getTileWidth(),displayHeight:1.2*e.getTileHeight(),yoyo:!0,repeat:1,duration:300,onStop:()=>{e.setDisplaySize(e.getTileWidth(),e.getTileHeight())}});this.hintTweens.push(t),e.on("pointerover",this.endHintTiles,this)}))}endHintTiles(){this.hintTweens.forEach((e=>{e.stop()})),this.hintTiles.forEach((e=>{e.off("pointerover",this.endHintTiles,this),e.setDisplaySize(e.getTileWidth(),e.getTileHeight())})),this.hintTweens=[]}},E=class{constructor(e,t,i,s){this.count=e,this.matchTiles=t,this.originTile=i,this.specialTileType=s,this.matchTilesExceptOrigin=this.matchTiles.filter((e=>e!==this.originTile))}},G=class{constructor(e,t,i){this.matchTiles=e,this.fromTile=t,this.toTile=i}},I=class{constructor(e){this.tileGrid=e}getMatches(){this.visitedTiles=new Set;let e=this.findVerticalMatches(),t=this.findHorizontalMatches(),i=this.findSquareMatches(),s=[];return this.extract5OrMoreContinuousMatch(e,s,t),this.extractCornerMatch(e,t,s),this.extract4ContinuousMatch(e,s,t),this.extractSquareMatch(i,s),this.extract3ContinuousMatch(e,s,t),s}extract5OrMoreContinuousMatch(e,t,i){this.sliceAllNonVisitedTileInMatch(e);for(let i=e.length-1;i>=0;i--){if(e[i].length<5)continue;let s=e[i],l=s[0],r=s.length;t.push(new E(r,s,l,"COLOR_CLEAR")),this.addToVisitedTiles(s),e.splice(i,1),this.sliceAllNonVisitedTileInMatch(e),i=e.length}this.sliceAllNonVisitedTileInMatch(i);for(let e=i.length-1;e>=0;e--){if(i[e].length<5)continue;let s=i[e],l=s[0],r=s.length;t.push(new E(r,s,l,"COLOR_CLEAR")),this.addToVisitedTiles(s),i.splice(e,1),this.sliceAllNonVisitedTileInMatch(i),e=i.length}}extractCornerMatch(e,t,i){this.sliceAllNonVisitedTileInMatch(e),this.sliceAllNonVisitedTileInMatch(t);for(let s=e.length-1;s>=0;s--)for(let l=t.length-1;l>=0&&!(s<0);l--){let r=e[s],h=t[l],o=this.intersection2TilesArray(r,h);if(0==o.length)continue;let n=this.union2TilesArray(r,h),a=o[0],d=n.length;i.push(new E(d,n,a,"BOMB")),this.addToVisitedTiles(n),t.splice(l,1),e.splice(s,1),this.sliceAllNonVisitedTileInMatch(e),this.sliceAllNonVisitedTileInMatch(t),s=e.length-1,l=t.length}}extract3ContinuousMatch(e,t,i){this.sliceAllNonVisitedTileInMatch(e);for(let i=e.length-1;i>=0;i--){if(3!=e[i].length)continue;let s=e[i],l=s[0],r=s.length;t.push(new E(r,s,l,"NONE")),this.addToVisitedTiles(s),e.splice(i,1),this.sliceAllNonVisitedTileInMatch(e),i=e.length}this.sliceAllNonVisitedTileInMatch(i);for(let e=i.length-1;e>=0;e--){if(3!=i[e].length)continue;let s=i[e],l=s[0],r=s.length;t.push(new E(r,s,l,"NONE")),this.addToVisitedTiles(s),i.splice(e,1),this.sliceAllNonVisitedTileInMatch(i),e=i.length}}extract4ContinuousMatch(e,t,i){this.sliceAllNonVisitedTileInMatch(e);for(let i=e.length-1;i>=0;i--){if(4!=e[i].length)continue;let s=e[i],l=s[0],r=s.length;t.push(new E(r,s,l,"ROW_CLEAR")),this.addToVisitedTiles(s),e.splice(i,1),this.sliceAllNonVisitedTileInMatch(e),i=e.length}this.sliceAllNonVisitedTileInMatch(i);for(let e=i.length-1;e>=0;e--){if(4!=i[e].length)continue;let s=i[e],l=s[0],r=s.length;t.push(new E(r,s,l,"COLUMN_CLEAR")),this.addToVisitedTiles(s),i.splice(e,1),this.sliceAllNonVisitedTileInMatch(i),e=i.length}}extractSquareMatch(e,t){this.sliceAllNonVisitedTileInMatch(e);for(let i=e.length-1;i>=0;i--){if(4!=e[i].length)continue;let s=e[i],l=s[0],r=s.length;t.push(new E(r,s,l,"RANDOM_2")),this.addToVisitedTiles(s),e.splice(i,1),this.sliceAllNonVisitedTileInMatch(e),i=e.length}}addToVisitedTiles(e){for(let t of e)this.visitedTiles.add(t)}sliceAllNonVisitedTileInMatch(e){for(let t=e.length-1;t>=0;t--){let i=e[t];for(let s=i.length-1;s>=0;s--)if(this.visitedTiles.has(i[s])){let l=i.slice(0,s),r=i.slice(s+1,i.length);e.splice(t,1),l.length>=3&&(e.push(l),t=e.length),r.length>=3&&(e.push(r),t=e.length);break}}}union2TilesArray(e,t){return[...new Set([...e,...t])]}union3TilesArray(e,t,i){return[...new Set([...e,...t,...i])]}intersection2TilesArray(e,t){return e.filter((e=>t.includes(e)))}intersection3TilesArray(e,t,i){return e.filter((e=>t.includes(e)&&i.includes(e)))}findHorizontalMatches(){let e=[],t=[];for(let i=0;i<this.tileGrid.getRowCount();i++){let s=this.tileGrid.getRow(i);t=[];for(let l=0;l<s.length-2;l++){let s=this.tileGrid.getTileAtIndex(l,i),r=this.tileGrid.getTileAtIndex(l+1,i),h=this.tileGrid.getTileAtIndex(l+2,i);s&&r&&h&&this.checkColorSame(s,r)&&this.checkColorSame(r,h)&&(t.length>0&&-1==t.indexOf(s)&&(e.push(t),t=[]),-1==t.indexOf(s)&&t.push(s),-1==t.indexOf(r)&&t.push(r),-1==t.indexOf(h)&&t.push(h))}t.length>0&&e.push(t)}return e}findVerticalMatches(){let e=[];for(let t=0;t<this.tileGrid.getColumnCount();t++){let i=[];for(let s=0;s<this.tileGrid.getRowCount()-2;s++){let l=this.tileGrid.getTileAtIndex(t,s),r=this.tileGrid.getTileAtIndex(t,s+1),h=this.tileGrid.getTileAtIndex(t,s+2);l&&r&&h&&this.checkColorSame(l,r)&&this.checkColorSame(r,h)&&(i.length>0&&-1==i.indexOf(l)&&(e.push(i),i=[]),-1==i.indexOf(l)&&i.push(l),-1==i.indexOf(r)&&i.push(r),-1==i.indexOf(h)&&i.push(h))}i.length>0&&e.push(i)}return e}findSquareMatches(){let e=[];for(let t=0;t<this.tileGrid.getRowCount()-1;t++)for(let i=0;i<this.tileGrid.getColumnCount()-1;i++){let s=this.tileGrid.getTileAtIndex(i,t),l=this.tileGrid.getTileAtIndex(i+1,t),r=this.tileGrid.getTileAtIndex(i,t+1),h=this.tileGrid.getTileAtIndex(i+1,t+1);s&&l&&r&&h&&this.checkColorSame(s,l)&&this.checkColorSame(s,r)&&this.checkColorSame(s,h)&&e.push([s,l,r,h])}return e}findPotentialHorizontalMatches(){let e=[];for(let t=0;t<this.tileGrid.getRowCount();t++){let i=this.tileGrid.getRow(t);for(let s=-1;s<i.length-2;s++){let i=this.tileGrid.getTileAtIndex(s,t),l=this.tileGrid.getTileAtIndex(s+1,t),r=this.tileGrid.getTileAtIndex(s+2,t),h=this.tileGrid.getTileAtIndex(s+3,t);if(i&&l&&r&&(!h||!this.checkColorSame(h,r))&&!this.checkColorSame(i,l)&&this.checkColorSame(l,r)){let h=this.tileGrid.getTileAtIndex(s,t-1),o=this.tileGrid.getTileAtIndex(s,t+1),n=this.tileGrid.getTileAtIndex(s-1,t),a=i,d=[l,r];h&&this.checkColorSame(h,l)&&e.push(new G(d,a,h)),o&&this.checkColorSame(o,l)&&e.push(new G(d,a,o)),n&&this.checkColorSame(n,l)&&e.push(new G(d,a,n))}if(l&&r&&h&&(!i||!this.checkColorSame(i,l))&&this.checkColorSame(l,r)&&!this.checkColorSame(l,h)){let i=this.tileGrid.getTileAtIndex(s+3,t-1),o=this.tileGrid.getTileAtIndex(s+3,t+1),n=this.tileGrid.getTileAtIndex(s+4,t),a=h,d=[l,r];i&&this.checkColorSame(i,l)&&e.push(new G(d,a,i)),o&&this.checkColorSame(o,l)&&e.push(new G(d,a,o)),n&&this.checkColorSame(n,l)&&e.push(new G(d,a,n))}if(i&&l&&r&&this.checkColorSame(i,r)&&!this.checkColorSame(l,i)){let h=this.tileGrid.getTileAtIndex(s+1,t-1),o=this.tileGrid.getTileAtIndex(s+1,t+1),n=l,a=[i,r];h&&this.checkColorSame(h,i)&&e.push(new G(a,n,h)),o&&this.checkColorSame(o,i)&&e.push(new G(a,n,o))}if(l&&r&&h&&this.checkColorSame(l,h)&&!this.checkColorSame(l,r)){let i=this.tileGrid.getTileAtIndex(s+2,t-1),o=this.tileGrid.getTileAtIndex(s+2,t+1),n=r,a=[l,h];i&&this.checkColorSame(i,l)&&e.push(new G(a,n,i)),o&&this.checkColorSame(o,l)&&e.push(new G(a,n,o))}}}return e}getPotentialMatches(){return[...this.findPotentialHorizontalMatches(),...this.findPotentialVerticalMatches()]}findPotentialVerticalMatches(){let e=[];for(let t=0;t<this.tileGrid.getColumnCount();t++)for(let i=-1;i<this.tileGrid.getRowCount()-2;i++){let s=this.tileGrid.getTileAtIndex(t,i),l=this.tileGrid.getTileAtIndex(t,i+1),r=this.tileGrid.getTileAtIndex(t,i+2),h=this.tileGrid.getTileAtIndex(t,i+3);if(s&&l&&r&&(!h||!this.checkColorSame(h,r))&&!this.checkColorSame(s,l)&&this.checkColorSame(l,r)){let h=this.tileGrid.getTileAtIndex(t-1,i),o=this.tileGrid.getTileAtIndex(t+1,i),n=this.tileGrid.getTileAtIndex(t,i-1),a=s,d=[l,r];h&&this.checkColorSame(h,l)&&e.push(new G(d,a,h)),o&&this.checkColorSame(o,l)&&e.push(new G(d,a,o)),n&&this.checkColorSame(n,l)&&e.push(new G(d,a,n))}if(l&&r&&h&&(!s||!this.checkColorSame(s,l))&&this.checkColorSame(l,r)&&!this.checkColorSame(l,h)){let s=this.tileGrid.getTileAtIndex(t-1,i+3),o=this.tileGrid.getTileAtIndex(t+1,i+3),n=this.tileGrid.getTileAtIndex(t,i+4),a=h,d=[l,r];n&&this.checkColorSame(n,l)&&e.push(new G(d,a,n)),s&&this.checkColorSame(s,l)&&e.push(new G(d,a,s)),o&&this.checkColorSame(o,l)&&e.push(new G(d,a,o))}if(s&&l&&r&&this.checkColorSame(s,r)&&!this.checkColorSame(l,s)){let h=this.tileGrid.getTileAtIndex(t-1,i+1),o=this.tileGrid.getTileAtIndex(t+1,i+1),n=l,a=[s,r];h&&this.checkColorSame(h,s)&&e.push(new G(a,n,h)),o&&this.checkColorSame(o,s)&&e.push(new G(a,n,o))}if(l&&r&&h&&this.checkColorSame(l,h)&&!this.checkColorSame(r,l)){let s=this.tileGrid.getTileAtIndex(t-1,i+2),o=this.tileGrid.getTileAtIndex(t+1,i+2),n=r,a=[l,h];s&&this.checkColorSame(s,l)&&e.push(new G(a,n,s)),o&&this.checkColorSame(o,l)&&e.push(new G(a,n,o))}}return e}checkColorSame(e,t){return!(!e||!t||""==e.getColor()||""==t.getColor())&&e.getColor()===t.getColor()}},M=class{constructor(e,t){this.scene=e,this.firstSelectedTile=null,this.secondSelectedTile=null,this.canMove=!0,this.isSwapped=!1,this.tileGrid=t}swapTiles(){if(this.firstSelectedTile&&this.secondSelectedTile){this.isSwapped=!0,this.tileGrid.swapTiles(this.firstSelectedTile,this.secondSelectedTile);const e=this.firstSelectedTile;this.firstSelectedTile=this.secondSelectedTile,this.secondSelectedTile=e}}unswapTiles(){if(this.firstSelectedTile&&this.secondSelectedTile){this.isSwapped=!1,this.tileGrid.swapTiles(this.firstSelectedTile,this.secondSelectedTile);const e=this.firstSelectedTile;this.firstSelectedTile=this.secondSelectedTile,this.secondSelectedTile=e}}selectTile(e){if(!this.canMove)return;if(!this.firstSelectedTile)return void(this.firstSelectedTile=e);if(this.firstSelectedTile===e)return void this.resetSelectedTile();this.secondSelectedTile=e;let t=0,i=0;if(this.firstSelectedTile&&this.secondSelectedTile){let e=this.tileGrid.getMahattanIndexDistance(this.firstSelectedTile,this.secondSelectedTile);t=e.x,i=e.y}1===t&&0===i||0===t&&1===i?(this.canMove=!1,this.swapTiles()):(this.firstSelectedTile=e,this.secondSelectedTile=null)}resetSelectedTile(){this.firstSelectedTile=null,this.secondSelectedTile=null,this.isSwapped=!1}setCanMove(e){this.canMove=e}checkIsSwapped(){return this.isSwapped}checkFirstTileSelected(){return null!==this.firstSelectedTile}getCanMove(){return this.canMove}};class A extends Phaser.Events.EventEmitter{constructor(e,t){super(),this.currentScore=0,this.targetScore=0,this.accumaletedScore=0,this.diffcultyScale=1,this.isEnable=!0,this.targetScore=e*t,this.accumaletedScore=e,this.diffcultyScale=t}setTargetScore(e){this.targetScore=e}setCurrentScore(e){this.currentScore=e,this.emit(A.SCORE_CHANGED_EVENT,this.currentScore,0,this.targetScore)}getCurrentScore(){return this.currentScore}getTargetScore(){return this.targetScore}setEnable(e){this.isEnable=e}addScore(e){this.isEnable&&(this.currentScore+=e,this.emit(A.SCORE_CHANGED_EVENT,this.currentScore,e,this.targetScore),this.currentScore>=this.targetScore&&(this.emit(A.TARGET_SCORE_REACHED_EVENT),this.currentScore=0,this.accumaletedScore*=this.diffcultyScale,this.targetScore+=this.accumaletedScore))}}A.SCORE_CHANGED_EVENT="scoreChanged",A.TARGET_SCORE_REACHED_EVENT="targetScoreReached";const P=A,b=class{constructor(e){this.isComplete=!1,this.tween=e,this.tween.on("complete",(()=>{this.isComplete=!0})),this.tween.pause(),this.isComplete=!1}update(){}start(){this.tween.play()}stop(){this.tween.stop()}getCompleted(){return this.isComplete}},v=class{constructor(e,t,i,s,l){this.type="NONE",this.scene=e,this.tile=t,this.color=i,this.texture=s,this.type=l}onTileAppear(e=[]){let t=this.scene.data.get("simulationController");const i=this.tile.scaleX,s=this.tile.scaleY;if(this.tile.setDepth(1),0==e.length)return void this.scene.add.tween({targets:this.tile,scaleX:{from:0,to:i},scaleY:{from:0,to:s},duration:500,ease:"Back.out"});let l=e.map((e=>{const t=e;return"NONE"!=t.type?null:t.tile}));const r=this.tile.getWorldPosition();this.tile.setScale(0,0),l.forEach((e=>{if(null==e)return;let i=e.getWorldPosition(),s=this.scene.add.image(i.tx,i.ty,e.texture);s.setDepth(0),s.setScale(e.scaleX,e.scaleY);let l=this.scene.add.tween({targets:s,x:r.tx,y:r.ty,scale:{from:s.scale,to:.6*s.scale},alpha:{from:1,to:.4},duration:500,ease:Phaser.Math.Easing.Cubic.In,onComplete:()=>{s.destroy()}});t.addSimulation(new b(l),!0)}));let h=this.scene.add.tween({delay:350,targets:this.tile,scaleX:{from:0,to:i},scaleY:{from:0,to:s},duration:500,ease:"Back.out"});t.addSimulation(new b(h),!0)}},N=class{constructor(e){this.isComplete=!1,this.tween=e,this.tween.on("complete",(()=>{this.isComplete=!0})),this.tween.pause(),this.isComplete=!1}update(){}start(){this.tween.play()}stop(){this.tween.stop()}getCompleted(){return this.isComplete}},O=class extends v{constructor(e,t,i,s){super(e,t,i,s,"RANDOM_2")}onTilePop(){let e=this.tile.getTileGrid();this.tileGrid=e;let t=e.getFlattenTileGrid(),i=t[Math.floor(Math.random()*t.length)],s=t[Math.floor(Math.random()*t.length)];if(!(t.length<2)){for(;i===this.tile||s===this.tile||i===s;)i=t[Math.floor(Math.random()*t.length)],s=t[Math.floor(Math.random()*t.length)];this.tileToDestroy1=i,this.tileToDestroy2=s,e.popTiles([i,s])}}onTileDestroy(){var e,t,i;let s=this.scene.data.get("simulationController"),l=this.tile.getWorldPosition(),r=this.scene.add.particles(l.tx,l.ty,this.texture,{radial:!0,angle:{min:0,max:360},speed:{min:500,max:1e3},quantity:15,lifespan:500,alpha:{start:1,end:0},scale:{min:.5,max:1},rotate:{min:0,max:360}});for(r.setScale(.15),r.explode(25),this.scene.time.delayedCall(2e3,(()=>{r.destroy()})),null===this.tileGrid.getTileIndexInPopedGrid(this.tileToDestroy1)&&(this.tileToDestroy1=null!==(e=this.tileGrid.getRandomTileInPopedGrid())&&void 0!==e?e:this.tileToDestroy1),null===this.tileGrid.getTileIndexInPopedGrid(this.tileToDestroy2)&&(this.tileToDestroy2=null!==(t=this.tileGrid.getRandomTileInPopedGrid())&&void 0!==t?t:this.tileToDestroy2);this.tileToDestroy1===this.tileToDestroy2;)this.tileToDestroy2=null!==(i=this.tileGrid.getRandomTileInPopedGrid())&&void 0!==i?i:this.tileToDestroy2;let h=this.createExplosionAnimation(this.tileToDestroy1),o=this.createExplosionAnimation(this.tileToDestroy2);s.addSimulation(new N(h),!0),s.addSimulation(new N(o),!0),this.scene.data.get("scoreController").addScore(1)}onTileSwapPop(e){console.log("BearTileEffect onTileSwapPop")}createExplosionAnimation(e){let t=this.tile.getWorldPosition(),i=e.getWorldPosition(),s=this.scene.add.image(t.tx,t.ty,this.texture);s.setFlipX(Math.random()>.5);let l=this.scene.add.image(i.tx,i.ty,"bomb-selection-01");return l.setVisible(!1),l.setPosition(i.tx,i.ty),this.scene.tweens.chain({tweens:[{targets:s,scale:{from:.25,to:1},x:{from:t.tx,to:(i.tx+t.tx)/2},y:{from:t.ty,to:(i.ty+t.ty)/2},duration:300,ease:"Quart.easeOut"},{targets:s,scale:{from:1,to:.25},x:{from:(i.tx+t.tx)/2,to:i.tx},y:{from:(i.ty+t.ty)/2,to:i.ty},duration:300,ease:"Sine.easeIn",onComplete:()=>{s.destroy()}},{targets:l,scale:{from:.25,to:1},alpha:{from:.5,to:2},duration:300,ease:"Linear",onStart:()=>{l.setVisible(!0)},onComplete:()=>{l.setVisible(!1),l.destroy(),this.tileGrid.destroyPopTile(e,this)}}]})}},k=class extends v{constructor(e,t,i,s){super(e,t,i,s,"BOMB"),this.tilesToDestroy=[]}onTilePop(){let e=this.tile.getTileGrid();this.tileGrid=e;let t=e.getTileIndex(this.tile,!0);this.tileIndex=t;for(let i=-1;i<=1;i++)for(let s=-1;s<=1;s++){let l=e.getTileAtIndex(t.x+i,t.y+s);null!=l&&l!=this.tile&&this.tilesToDestroy.push(l)}e.popTiles(this.tilesToDestroy)}onTileDestroy(){let e=this.scene.data.get("simulationController"),t=this.tile.getWorldPosition(),i=this.scene.add.sprite(t.tx,t.ty,"bomb-05");i.play("bomb-animation");let s=this.scene.tweens.chain({tweens:[{targets:i,scale:{from:0,to:1.5},alpha:{from:0,to:.8},duration:500,ease:"Cubic.easeOut"},{targets:i,alpha:{from:.8,to:0},duration:300,ease:"Cubic.easeIn"}],onComplete:()=>{i.destroy()}});this.tilesToDestroy.forEach((e=>{this.tileGrid.destroyPopTile(e,this)})),e.addSimulation(new N(s),!0),this.scene.data.get("scoreController").addScore(1)}onTileSwapPop(e){console.log("BombTileEffect onTileSwapPop")}},D=class extends v{constructor(e,t,i,s){super(e,t,i,s,"COLOR_CLEAR")}onTilePop(){let e=h[Math.floor(Math.random()*h.length)];this.popTileColor(e)}onTileDestroy(){this.scene.data.get("simulationController"),this.tile.getWorldPosition(),this.scene.data.get("scoreController").addScore(1),this.tileToDestroy.forEach((e=>{this.tileGrid.destroyPopTile(e,this)}))}onTileSwapPop(e){"NONE"===e.type&&this.popTileColor(e.color)}popTileColor(e){let t=this.tile.getTileGrid();this.tileGrid=t;let i=t.getFlattenTileGrid().filter((t=>t.getColor()===e));this.tileToDestroy=i,t.popTiles(i)}},_=class extends v{constructor(e,t,i,s){super(e,t,i,s,"ROW_CLEAR"),this.popTilesRight=[],this.popTilesLeft=[]}onTilePop(){let e=this.tile.getTileGrid(),t=e.getTileIndex(this.tile,!0);this.tileIndex=t;for(let i=t.x+1;i<e.getRowCount();i++){let s=e.getTileAtIndex(i,t.y);null!=s&&s!=this.tile&&this.popTilesLeft.push(s)}for(let i=t.x-1;i>=0;i--){let s=e.getTileAtIndex(i,t.y);null!=s&&s!=this.tile&&this.popTilesRight.push(s)}e.popTiles(this.popTilesRight),e.popTiles(this.popTilesLeft)}onTileDestroy(){let e=this.scene.data.get("simulationController"),t=this.tile.getWorldPosition(),i=this.tile.getTileGrid(),s=this.scene.add.image(t.tx,t.ty,"stripes_destroy");s.setOrigin(1,.5);let l=new Set;const r=e=>{const t=e.getValue(),s=e.targets;l.has(Math.floor(t))||i.destroyPopTile(s[Math.floor(t)],this)};let h=this.scene.tweens.chain({tweens:[{targets:s,x:{from:t.tx,to:t.tx+500},scaleY:{from:.8,to:1.2},scaleX:{from:1,to:4},duration:250,ease:"Cubic.in"},{targets:s,x:{from:t.tx+500,to:t.tx+1e3},duration:250,ease:"Cubic.out"}]}),o=this.scene.add.image(t.tx,t.ty,"stripes_destroy");o.setOrigin(0,.5);let n=this.scene.tweens.chain({tweens:[{targets:o,x:{from:t.tx,to:t.tx-500},scaleY:{from:.8,to:1.2},scaleX:{from:1,to:4},duration:250,ease:"Cubic.in"},{targets:o,x:{from:t.tx-500,to:t.tx-1e3},duration:250,ease:"Cubic.out"}]}),a=this.scene.add.tween({targets:this.popTilesRight,values:{from:0,to:this.popTilesRight.length-1},duration:400,ease:"Linear",onUpdate:r}),d=this.scene.add.tween({targets:this.popTilesLeft,values:{from:0,to:this.popTilesLeft.length-1},duration:400,ease:"Linear",onUpdate:r});e.addSimulation(new N(h),!0),e.addSimulation(new N(n),!0),e.addSimulation(new b(a),!0),e.addSimulation(new b(d),!0),this.scene.time.delayedCall(500,(()=>{s.destroy(),o.destroy()})),this.scene.data.get("scoreController").addScore(1)}onTileSwapPop(e){console.log("HorizontalStripeTileEffect onTileSwapPop")}},V=class{constructor(e,t,i,s=0){this.isComplete=!1,this.timerEvent=e.time.addEvent({delay:t,callback:i,callbackScope:this,repeat:s,loop:!1,paused:!0})}update(){}start(){this.timerEvent.paused=!1}stop(){this.timerEvent.paused=!0,this.timerEvent.remove(!1),this.isComplete=!0}getCompleted(){return this.isComplete||0==this.timerEvent.getOverallRemainingSeconds()}},R=class extends v{constructor(e,t,i,s){super(e,t,i,s,"NONE")}onTilePop(){}onTileDestroy(e){this.scene.data.get("scoreController").addScore(1);let t=this.scene.data.get("simulationController"),i=this.tile.getWorldPosition(),s=this.scene.add.particles(i.tx,i.ty,this.texture,{radial:!0,angle:{min:0,max:360},speed:{min:500,max:1e3},quantity:15,lifespan:500,alpha:{start:1,end:0},scale:{min:.5,max:1},rotate:{min:0,max:360}});s.setScale(.15),s.explode(25),t.addSimulation(new V(this.scene,600,(()=>{s.destroy()})))}onTileSwapPop(e){}},W=class extends v{constructor(e,t,i,s){super(e,t,i,s,"COLUMN_CLEAR"),this.popTilesUp=[],this.popTilesDown=[]}onTilePop(){let e=this.tile.getTileGrid(),t=e.getTileIndex(this.tile,!0);this.tileIndex=t;for(let i=t.y+1;i<e.getRowCount();i++){let s=e.getTileAtIndex(t.x,i);null!=s&&s!=this.tile&&this.popTilesDown.push(s)}for(let i=t.y-1;i>=0;i--){let s=e.getTileAtIndex(t.x,i);null!=s&&s!=this.tile&&this.popTilesUp.push(s)}e.popTiles(this.popTilesUp),e.popTiles(this.popTilesDown)}onTileDestroy(){let e=this.scene.data.get("simulationController"),t=this.tile.getWorldPosition(),i=this.tile.getTileGrid(),s=this.scene.add.image(t.tx,t.ty,"stripes_destroy");s.setRotation(Math.PI/2),s.setOrigin(0,.5);let l=new Set;const r=e=>{const t=e.getValue(),s=e.targets;l.has(Math.floor(t))||i.destroyPopTile(s[Math.floor(t)],this)};let h=this.scene.tweens.chain({tweens:[{targets:s,y:{from:t.ty,to:t.ty+200},scaleY:{from:1,to:1.5},scaleX:{from:1,to:5},duration:350,ease:"Cubic.in"},{targets:s,y:{from:t.ty+200,to:t.ty+400},duration:350,ease:"Cubic.out"}]}),o=this.scene.add.image(t.tx,t.ty,"stripes_destroy");o.setRotation(-Math.PI/2),o.setOrigin(0,.5);let n=this.scene.tweens.chain({tweens:[{targets:o,y:{from:t.ty,to:t.ty-200},scaleY:{from:1,to:1.5},scaleX:{from:1,to:5},duration:350,ease:"Cubic.in"},{targets:o,y:{from:t.ty-200,to:t.ty-400},duration:350,ease:"Cubic.out"}]}),a=this.scene.add.tween({targets:this.popTilesUp,values:{from:0,to:this.popTilesUp.length-1},duration:400,ease:"Linear",onUpdate:r}),d=this.scene.add.tween({targets:this.popTilesDown,values:{from:0,to:this.popTilesDown.length-1},duration:400,ease:"Linear",onUpdate:r});e.addSimulation(new N(h),!0),e.addSimulation(new N(n),!0),e.addSimulation(new b(a),!0),e.addSimulation(new b(d),!0),this.scene.time.delayedCall(700,(()=>{s.destroy(),o.destroy()})),this.scene.data.get("scoreController").addScore(1)}onTileSwapPop(e){console.log("VerticalStripeTileEffect onTileSwapPop")}},H=class{constructor(e,t,i,s){this.scene=e,this.colors=t,this.textureWidth=i,this.textureHeight=s}createRandomTile(e,t){let i=this.colors[Phaser.Math.RND.between(0,this.colors.length-1)],s=o.normalCandyTextureKey[i],l=new d({scene:this.scene,x:e,y:t,texture:s});return l.setDisplaySize(this.textureWidth,this.textureHeight).setTileEffect(new R(this.scene,l,i,s)),l}createSpecialTile(e,t,i,s){let l=this.getSpecialTileTexture(t,e),r=new d({scene:this.scene,x:i,y:s,texture:l});r.setDisplaySize(this.textureWidth,this.textureHeight);let h=this.getSpecialTileEffect(t,e,r);return r.setTileEffect(h),r}getSpecialTileTexture(e,t){switch(e){case"BOMB":return o.bombCandyTextureKey[t];case"COLOR_CLEAR":return o.cholateCandyTextureKey;case"COLUMN_CLEAR":return o.verticalStripesCandyTextureKey[t];case"ROW_CLEAR":return o.horizontalStripesCandyTextureKey[t];case"RANDOM_2":return o.bearCandyTextureKey[t];default:return o.normalCandyTextureKey[t]}}getSpecialTileEffect(e,t,i){switch(e){case"BOMB":return new k(this.scene,i,t,o.bombCandyTextureKey[t]);case"COLOR_CLEAR":return new D(this.scene,i,"",o.cholateCandyTextureKey);case"COLUMN_CLEAR":return new W(this.scene,i,t,o.verticalStripesCandyTextureKey[t]);case"ROW_CLEAR":return new _(this.scene,i,t,o.horizontalStripesCandyTextureKey[t]);case"RANDOM_2":return new O(this.scene,i,t,o.bearCandyTextureKey[t]);default:return new R(this.scene,i,t,o.normalCandyTextureKey[t])}}};class L extends s.GameObjects.Container{constructor(e,t,i,s,l){super(e,t,i),this.progressBar=this.scene.add.nineslice(t,i,"progress-bar-02","",s,l),this.progressBar.setOrigin(0,.5),this.add(this.progressBar),this.progressBar.setDisplaySize(s,l),this.progressFill=this.scene.add.nineslice(t+10,i,"progress-bar-01","",.975*s,l,s/4,s/4),this.progressFill.setOrigin(0,.5),this.add(this.progressFill),this.progressFill.setScale(0,1),this.progressBorder=this.scene.add.nineslice(t,i,"progress-bar-03","",s,l),this.progressBorder.setOrigin(0,.5),this.add(this.progressBorder),this.progressBorder.setDisplaySize(s,l),this.scene.add.existing(this)}setProgress(e){e<0&&(e=0),e>1&&(e=1),this.moveTween&&this.moveTween.stop(),this.moveTween=this.scene.add.tween({targets:this.progressFill,duration:500,scaleX:e,ease:"Cubic.easeOut"})}}const z=L;class B extends Phaser.GameObjects.GameObject{constructor(e){super(e,"SimulationController"),this.simulations=[],this.hasStarted=!1,this.hasEnded=!1,this.hasCompleted=!1,this.nextSimulations=[],this.hasInvokeNextStart=!1,this.completeCallback=this.emptyFunction,this.endCallback=this.emptyFunction,this.nextCompleteCallback=this.emptyFunction,this.nextEndCallback=this.emptyFunction,this.simulations=[],this.scene.events.on("update",this.update,this)}update(...e){this.hasInvokeNextStart&&this.hasEnded&&(this.extractNextSimulations(),this.startSimulation(this.completeCallback,this.endCallback)),this.getCompleted()&&this.hasStarted&&!this.hasCompleted&&!this.hasEnded&&(this.hasCompleted=!0,this.simulations=[],this.completeCallback(),this.emit(B.COMPLETE_EVENT),this.hasEnded=!1),this.getCompleted()&&this.hasStarted&&this.hasCompleted&&!this.hasEnded&&(this.hasEnded=!0,this.simulations=[],this.endCallback(),this.emit(B.END_EVENT))}addSimulation(e,t=!1){return this.hasCompleted?this.hasCompleted&&!this.hasEnded&&t?(this.simulations.push(e),void e.start()):void this.nextSimulations.push(e):(this.simulations.push(e),void e.start())}startSimulation(e,t){if(this.hasStarted&&!this.hasEnded)return this.hasInvokeNextStart=!0,this.nextCompleteCallback=e||this.emptyFunction,void(this.nextEndCallback=t||this.emptyFunction);this.hasStarted=!0,this.hasInvokeNextStart=!1,this.hasCompleted=!1,this.hasEnded=!1,0==this.simulations.length&&0!=this.nextSimulations.length&&this.extractNextSimulations(),this.completeCallback=e||this.emptyFunction,this.endCallback=t||this.emptyFunction,this.simulations.forEach((e=>{e.start()})),this.emit(B.START_EVENT)}extractNextSimulations(){this.simulations=this.nextSimulations,this.nextSimulations=[],this.hasInvokeNextStart=!1,this.completeCallback=this.nextCompleteCallback,this.endCallback=this.nextEndCallback,this.nextCompleteCallback=this.emptyFunction,this.nextEndCallback=this.emptyFunction}emptyFunction(){}removeSimulation(e){this.simulations=this.simulations.filter((t=>t!==e))}stopSimulation(){this.simulations.forEach((e=>{e.stop()})),this.hasStarted=!1}getCompleted(){let e=!0;return this.simulations.forEach((t=>{t.getCompleted()||(e=!1)})),e}getSimulations(){return this.simulations}}B.COMPLETE_EVENT="complete",B.START_EVENT="start",B.END_EVENT="end";const F=B;class U extends Phaser.GameObjects.Graphics{constructor(e,t,i,s=1e3,l=new Phaser.Math.Vector2(0,-1),r=1e3,h=10,o=10){super(e),this.duration=1e3,this.deltaTime=0,this.direction=new Phaser.Math.Vector2(1,0),this.speed=100,this.spreadAngleDegree=10,this.frequency=10,this.scene=e,this.x=t,this.y=i,this.duration=s,this.direction=l.normalize(),this.speed=r,this.spreadAngleDegree=h,this.frequency=o,this.scene.add.existing(this),this.scene.events.on("update",this.update,this),this.createConffeti()}update(e,t){this.deltaTime=t/1e3}createConffeti(){this.scene.add.particles(this.x,this.y,"sunset-raster",{speed:{onEmit:e=>Phaser.Math.Between(this.speed,1.3*this.speed)*this.direction.y},angle:{onEmit:e=>Phaser.Math.RadToDeg(Phaser.Math.Angle.Between(0,0,this.direction.x,this.direction.y))+Phaser.Math.Between(-this.spreadAngleDegree,this.spreadAngleDegree)},lifespan:2*this.duration,frequency:this.frequency,duration:this.duration/2,frame:[0,4,8,12,16],x:{onEmit:e=>Phaser.Math.Between(0,0),onUpdate:(e,t,i)=>(e.velocityY<0?e.velocityY+=500*this.deltaTime:(e.velocityY+=150*this.deltaTime,e.velocityX*=.995),e.x)},scaleX:{onEmit:e=>-1,onUpdate:e=>e.scaleX>1?-1:e.scaleX+.05},rotate:{onEmit:e=>0,onUpdate:e=>e.angle+1}}),this.scene.time.delayedCall(this.duration,(()=>{this.scene.events.off("update",this.update,this),this.destroy()}))}}const K=U;class j extends Phaser.Scene{constructor(){super({key:"GameScene"}),this.isReachTargetedScore=!1}create(){this.initializeVariables(),this.initializeBindEvents(),this.setBackground(),this.initializeGrid(),this.startCheckMatch()}initializeVariables(){this.simulationController=new F(this),this.scoreController=new P(50,1),this.data.set("simulationController",this.simulationController),this.data.set("scoreController",this.scoreController),this.tileFactory=new H(this,h,o.tileWidth,o.tileHeight),this.tileGrid=new g(this,400,70,o.gridWidth,o.gridHeight,o.tileWidth,o.tileHeight,this.tileFactory,["item-spot-01","item-spot-02"]),this.tileMatcher=new I(this.tileGrid),this.tileSwapper=new M(this,this.tileGrid),this.tileHinter=new w(this,this.tileMatcher),this.gameInputHandler=new p(this,this.tileSwapper),this.tileGridDirector=new C(this,this.tileGrid),this.progressUi=new z(this,200,360,600,40),this.progressUi.setDepth(100)}setBackground(){this.cameras.main.setBackgroundColor(7908062);const e=this.add.image(0,0,"background-01");e.setOrigin(0,0),e.setDisplaySize(this.game.canvas.width+50,this.game.canvas.height+50),e.setDepth(-100)}initializeGrid(){this.tileGrid.on(g.TILE_ADD_EVENT,this.tweenDropdownTile,this),this.tileGrid.on(g.TILE_GRAVITATE_EVENT,this.tweenDropdownTile,this),this.tileGrid.on(g.TILE_SWAP_EVENT,this.tweenSwapTiles,this),this.tileGrid.initializeTiles()}initializeBindEvents(){let e=0;this.gameInputHandler.on(p.NO_INPUT_PERIOD_EVENT,(()=>{e++,e%3==0?this.tileGridDirector.startIdle():this.tileHinter.startHintTiles()})),this.simulationController.on(F.END_EVENT,(()=>{this.gameInputHandler.startTimer()})),this.simulationController.on(F.START_EVENT,(()=>{this.gameInputHandler.stopTimer()})),this.scoreController.on(P.SCORE_CHANGED_EVENT,((e,t,i)=>{this.progressUi.setProgress(e/i)})),this.scoreController.on(P.TARGET_SCORE_REACHED_EVENT,(()=>{this.isReachTargetedScore=!0,this.scoreController.setEnable(!1)}))}startCheckMatch(){this.tileSwapper.setCanMove(!1);let e=!1;const t=()=>{this.tileGridDirector.startShuffle(690,370,5e3,(()=>{this.checkMatches()?this.startCheckMatch():i()})),new K(this,0,800,4e3,new Phaser.Math.Vector2(1,-2),900,30,5),new K(this,1400,800,4e3,new Phaser.Math.Vector2(-1,-2),900,30,5)},i=()=>{0==this.tileMatcher.getPotentialMatches().length?t():this.tileSwapper.setCanMove(!0)};this.simulationController.startSimulation((()=>{e=this.checkMatches()}),(()=>{e?this.startCheckMatch():this.isReachTargetedScore?(this.isReachTargetedScore=!1,this.scoreController.setEnable(!0),this.scoreController.setCurrentScore(0),t()):i()}))}checkMatches(){let e=this.tileMatcher.getMatches();if(e.length>0){let t=new Map,i=new Map;return e.forEach((e=>{"NONE"!==e.specialTileType&&t.set(e.originTile,{x:e.originTile.x,y:e.originTile.y}),this.tileGrid.popTiles(e.matchTiles)})),e.forEach((e=>{if("NONE"!==e.specialTileType){let s=this.tileFactory.createSpecialTile(e.originTile.getColor(),e.specialTileType,e.originTile.x,e.originTile.y);this.tileGrid.addTileAtLocalPosition(s,t.get(e.originTile).x,t.get(e.originTile).y);let l=e.matchTilesExceptOrigin.map((e=>e.getTileEffect()));s.setAppear(l),i.set(e.originTile,s)}})),this.tileGrid.gravitateTile(),this.tileGrid.fillEmptyGridWithTile(),e.forEach((e=>{e.matchTiles.forEach((t=>{"NONE"!==e.specialTileType?this.tileGrid.destroyPopTile(t,i.get(e.originTile).getTileEffect(),!0):this.tileGrid.destroyPopTile(t)}))})),!0}return!1}checkSwap(e,t){let i=e.getTileEffect().type,s=t.getTileEffect().type;if("NONE"===i&&"NONE"===s)return!1;if("NONE"===i&&"COLOR_CLEAR"!==s)return!1;if("NONE"===s&&"COLOR_CLEAR"!==i)return!1;if("NONE"===i){const i=e;e=t,t=i}return this.tileGrid.swapPopTiles(e,t),this.tileGrid.gravitateTile(),this.tileGrid.fillEmptyGridWithTile(),this.tileGrid.destroyPopTile(e),this.tileGrid.destroyPopTile(t,e.getTileEffect(),!1),!0}tweenDropdownTile(e,t,i,s,l){const r=new N(this.tweens.chain({tweens:[{targets:e,delay:1500/(Math.pow(l,2)+3),y:(l+.5)*o.tileHeight,ease:"Cubic.In",duration:Math.max(150*(l-i),300),repeat:0,yoyo:!1}],onActive:()=>{e.disableTileInteraction()},onComplete:()=>{var t;null===(t=e.getMapTween("displaySize"))||void 0===t||t.stop();const s=e.displayHeight,r=e.displayWidth;let h=this.tweens.add({targets:e,y:e.y-4*(l-i),displayHeight:.8*s,displayWidth:1.2*r,ease:"Quad.Out",duration:100,yoyo:!0,repeat:0,onComplete:()=>{e.removeMapTween("displaySize"),e.enableTileInteraction()},onStop:()=>{e.setDisplaySize(r,s),e.removeMapTween("displaySize")}});e.addMapTween("displaySize",h)}}));this.simulationController.addSimulation(r)}tweenSwapTiles(e,t){const i=new b(this.add.tween({targets:e,x:t.x,y:t.y,ease:"Linear",duration:250,repeat:0,yoyo:!1})),s=new b(this.add.tween({targets:t,x:e.x,y:e.y,ease:"Linear",duration:250,repeat:0,yoyo:!1}));this.simulationController.addSimulation(i),this.simulationController.addSimulation(s);let l=!1,r=!1;this.simulationController.startSimulation((()=>{r=this.checkSwap(e,t),r||(l=this.checkMatches())}),(()=>{r||l?(this.tileSwapper.resetSelectedTile(),this.startCheckMatch()):this.tileSwapper.checkIsSwapped()?this.tileSwapper.unswapTiles():(this.tileSwapper.resetSelectedTile(),this.tileSwapper.setCanMove(!0))}))}}const X=j,Y={title:"Candy crush",url:"https://github.com/digitsensitive/phaser3-typescript",version:"0.0.1",type:Phaser.AUTO,autoCenter:Phaser.Scale.CENTER_BOTH,scale:{mode:Phaser.Scale.FIT,width:1400,height:787.5},parent:"game",scene:[r,X],backgroundColor:"#de3412",render:{pixelArt:!1,antialias:!0}};class q extends Phaser.Game{constructor(e){super(e)}}window.addEventListener("load",(()=>{new q(Y)}))}},i={};function s(e){var l=i[e];if(void 0!==l)return l.exports;var r=i[e]={exports:{}};return t[e].call(r.exports,r,r.exports,s),r.exports}s.m=t,e=[],s.O=(t,i,l,r)=>{if(!i){var h=1/0;for(d=0;d<e.length;d++){for(var[i,l,r]=e[d],o=!0,n=0;n<i.length;n++)(!1&r||h>=r)&&Object.keys(s.O).every((e=>s.O[e](i[n])))?i.splice(n--,1):(o=!1,r<h&&(h=r));if(o){e.splice(d--,1);var a=l();void 0!==a&&(t=a)}}return t}r=r||0;for(var d=e.length;d>0&&e[d-1][2]>r;d--)e[d]=e[d-1];e[d]=[i,l,r]},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{var e={792:0};s.O.j=t=>0===e[t];var t=(t,i)=>{var l,r,[h,o,n]=i,a=0;if(h.some((t=>0!==e[t]))){for(l in o)s.o(o,l)&&(s.m[l]=o[l]);if(n)var d=n(s)}for(t&&t(i);a<h.length;a++)r=h[a],s.o(e,r)&&e[r]&&e[r][0](),e[r]=0;return s.O(d)},i=self.webpackChunktype_project_template=self.webpackChunktype_project_template||[];i.forEach(t.bind(null,0)),i.push=t.bind(null,i.push.bind(i))})();var l=s.O(void 0,[96],(()=>s(96)));l=s.O(l)})();